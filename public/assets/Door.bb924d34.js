var e=Object.defineProperty,o=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,i=(o,t,r)=>t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r,n=(e,o)=>{for(var t in o||(o={}))l.call(o,t)&&i(e,t,o[t]);if(r)for(var t of r(o))a.call(o,t)&&i(e,t,o[t]);return e},d=(e,r)=>o(e,t(r));import{i as u}from"./index.c60800b2.js";import{a as s}from"./axios.1f9a9e3a.js";import{h as p}from"./index.36530c03.js";import{O as m,e as c,Q as f,r as g,o as b,c as h,R as w,b as v,d as y,W as C,p as P,a as _,X as D,Y as x,t as F,T as M,w as S}from"./vendor.559dc3a1.js";import{h as V,e as k,F as R}from"./FileSaver.min.81b7fc4b.js";const j={name:"DialogEditDoor",props:{type:String},emits:["success"],setup(e,o){const t=m(null),r=c({visible:!1,oldForm:null,ruleForm:{ip:"",doorNo:"",building:"",unit:""},rules:{ip:[{required:"true",message:"IP 不能為空",trigger:["change"]}],doorNo:[{required:"true",message:"門禁編碼不能為空",trigger:["change"]}],building:[{required:"true",message:"樓號不能為空",trigger:["change"]}],unit:[{required:"true",message:"單元號不能為空",trigger:["change"]}]}});return d(n({formRef:t},f(r)),{open:e=>{r.oldForm=e;const o=Object.assign({},e);r.ruleForm=o,r.visible=!0},submitForm:()=>{t.value.validate().then((t=>{if(t)if("add"==e.type)s.put("/door/add",r.ruleForm).then((()=>{o.emit("success"),r.visible=!1})).catch((e=>{s.isAxiosError(e)?p(e):console.error(e)}));else{if(u(r.oldForm,r.ruleForm))return void(r.visible=!1);console.log("提交服务器"),s.post("/door/update",r.ruleForm).then((()=>{o.emit("success"),r.visible=!1})).catch((e=>{s.isAxiosError(e)?p(e):console.error(e)}))}}))}})}},O={class:"dialog-footer"},z=y("取 消"),N=y("確 定");j.render=function(e,o,t,r,l,a){const i=g("el-input"),n=g("el-form-item"),d=g("el-form"),u=g("el-button"),s=g("el-dialog");return b(),h(s,{title:"add"==t.type?"添加門禁":"修改門禁",modelValue:e.visible,"onUpdate:modelValue":o[6]||(o[6]=o=>e.visible=o),width:"400px"},{footer:w((()=>[v("span",O,[v(u,{onClick:o[5]||(o[5]=o=>e.visible=!1)},{default:w((()=>[z])),_:1}),v(u,{type:"primary",onClick:r.submitForm},{default:w((()=>[N])),_:1},8,["onClick"])])])),default:w((()=>[v(d,{model:e.ruleForm,rules:e.rules,ref:"formRef","label-width":"100px",class:"door-form"},{default:w((()=>[v(n,{label:"CustomID",prop:"ip"},{default:w((()=>[v(i,{type:"text",modelValue:e.ruleForm.ip,"onUpdate:modelValue":o[1]||(o[1]=o=>e.ruleForm.ip=o)},null,8,["modelValue"])])),_:1}),v(n,{label:"門禁編碼",prop:"doorNo"},{default:w((()=>[v(i,{type:"text",modelValue:e.ruleForm.doorNo,"onUpdate:modelValue":o[2]||(o[2]=o=>e.ruleForm.doorNo=o)},null,8,["modelValue"])])),_:1}),v(n,{label:"樓號",prop:"building"},{default:w((()=>[v(i,{type:"text",modelValue:e.ruleForm.building,"onUpdate:modelValue":o[3]||(o[3]=o=>e.ruleForm.building=o)},null,8,["modelValue"])])),_:1}),v(n,{label:"單元號",prop:"unit"},{default:w((()=>[v(i,{type:"text",modelValue:e.ruleForm.unit,"onUpdate:modelValue":o[4]||(o[4]=o=>e.ruleForm.unit=o)},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["title","modelValue"])};const E={name:"Door",components:{DialogEditDoor:j},setup(){const e=m(null),o=m(null),t=c({loading:!1,doorMap:{},list:[],tableData:[],total:0,currentPage:1,pageSize:10,type:"add"});C((()=>{r()}));const r=()=>{t.loading=!0,s.get("/door/list").then((({list:e,doorMap:o})=>{const r=(t.currentPage-1)*t.pageSize,l=r+t.pageSize;t.list=e,t.total=e.length,t.tableData=e.slice(r,l),t.doorMap=o,t.loading=!1})).catch((e=>{console.error(e)}))},l=e=>{if(e&&t.doorMap[e]&&t.doorMap[e].serialPort){const{serialPort:{inputPortPath:o,inputPortRate:r}}=t.doorMap[e];return`${o}:${r}`}return""},a=e=>{if(e&&t.doorMap[e]&&t.doorMap[e].serialPort){const{serialPort:{outputPortPath:o,outputPortRate:r}}=t.doorMap[e];return`${o}:${r}`}return""},i=e=>{if(e&&t.doorMap[e]){const{now:o}=t.doorMap[e];return V(o).fromNow()}return""},u=e=>{if(e&&t.doorMap[e]&&t.doorMap[e].serialPort){const{serialPort:{state:o}}=t.doorMap[e];return o}return""};return d(n({tableRef:e,editItemRef:o},f(t)),{handleAdd:()=>{t.type="add",o.value.open({ip:"",doorNo:"",building:"",unit:""})},handleDownload:()=>{const e=V().format("YYYYMMDD_HHmmss"),o=t.list,r=`Door_${e}.xlsx`,n=new k.exports.Workbook,d=n.addWorksheet("Door");d.addRow(["CustomID","接收端口","發送端口","門禁編碼","樓號","單元號","Last seen","State"]),d.getColumn(1).width=24,d.getColumn(2).width=16,d.getColumn(3).width=18,d.getColumn(4).width=18,d.getColumn(5).width=18,d.getColumn(6).width=18,d.getColumn(7).width=24,d.getColumn(8).width=12,d.getRow(1).font={size:12,bold:!0};for(let t=0,s=o.length;t<s;t++){const{ip:e,doorNo:r,building:n,unit:s}=o[t],p=l(e),m=a(e),c=i(e),f=u(e);d.addRow([e,p,m,r,n,s,c,f])}n.xlsx.writeBuffer().then((e=>{R.exports.saveAs(new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r)})).catch((e=>{console.error(e)}))},handleEdit:e=>{t.type="edit",o.value.open(e)},handleDelete:e=>{console.log({_id:e}),s.delete("/door/remove",{data:{_id:e}}).then((()=>{r()}))},changePage:e=>{t.currentPage=e,r()},refreshData:r,formatReceivePort:l,formatSendPort:a,formatTime:i,formatState:u,formatCount:e=>{if(e&&t.doorMap[e]){const{count:o}=t.doorMap[e];return o}return""}})}},I=S();P("data-v-2a7e6638");const A={class:"header"},U=y("添加"),Y=y("導出"),$=v("a",{style:{cursor:"pointer"}},"删除",-1);_();const q=I(((e,o,t,r,l,a)=>{const i=g("el-button"),n=g("el-table-column"),d=g("el-popconfirm"),u=g("el-table"),s=g("el-pagination"),p=g("el-card"),m=g("DialogEditDoor"),c=D("loading");return b(),h(M,null,[v(p,{class:"index-container"},{header:I((()=>[v("div",A,[v(i,{type:"primary",size:"small",icon:"el-icon-plus",onClick:r.handleAdd},{default:I((()=>[U])),_:1},8,["onClick"]),v(i,{size:"small",icon:"el-icon-download",onClick:r.handleDownload},{default:I((()=>[Y])),_:1},8,["onClick"])])])),default:I((()=>[x(v(u,{ref:"tableRef",data:e.tableData,"tooltip-effect":"dark",style:{width:"100%"}},{default:I((()=>[v(n,{prop:"ip",label:"CustomID",width:"200"}),v(n,{label:"接收端口",width:"200"},{default:I((e=>[v("div",null,F(r.formatReceivePort(e.row.ip)),1)])),_:1}),v(n,{label:"發送端口",width:"200"},{default:I((e=>[v("div",null,F(r.formatSendPort(e.row.ip)),1)])),_:1}),v(n,{prop:"doorNo",label:"門禁編碼",width:"200"}),v(n,{prop:"building",label:"樓號",width:"200"}),v(n,{prop:"unit",label:"單元號"}),v(n,{label:"Last seen",width:"200"},{default:I((e=>[v("div",null,F(r.formatTime(e.row.ip)),1)])),_:1}),v(n,{label:"State",width:"200"},{default:I((e=>[v("div",null,F(r.formatState(e.row.ip)),1)])),_:1}),v(n,{label:"Waiting",width:"200"},{default:I((e=>[v("div",null,F(r.formatCount(e.row.ip)),1)])),_:1}),v(n,{label:"操作",width:"100"},{default:I((e=>[v("a",{style:{cursor:"pointer","margin-right":"10px"},onClick:o=>r.handleEdit(e.row)},"修改",8,["onClick"]),v(d,{title:"确定删除吗？",onConfirm:o=>r.handleDelete(e.row._id)},{reference:I((()=>[$])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"]),[[c,e.loading]]),v(s,{background:"",layout:"prev, pager, next",total:e.total,"page-size":e.pageSize,"current-page":e.currentPage,onCurrentChange:r.changePage},null,8,["total","page-size","current-page","onCurrentChange"])])),_:1}),v(m,{ref:"editItemRef",type:e.type,onSuccess:r.refreshData},null,8,["type","onSuccess"])],64)}));E.render=q,E.__scopeId="data-v-2a7e6638";export default E;
