var e=Object.defineProperty,o=Object.defineProperties,l=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,n=(o,l,r)=>l in o?e(o,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[l]=r,d=(e,o)=>{for(var l in o||(o={}))a.call(o,l)&&n(e,l,o[l]);if(r)for(var l of r(o))t.call(o,l)&&n(e,l,o[l]);return e},s=(e,r)=>o(e,l(r));import{O as i,e as u,P as c,Q as p,r as m,o as g,c as f,R as b,b as h,S as y,T as w,U as v,t as C,_,d as F,W as x,p as I,a as V,X as k,Y as O,w as D}from"./vendor.559dc3a1.js";import{h as j}from"./index.36530c03.js";import{i as N}from"./index.c60800b2.js";import{a as P}from"./axios.1f9a9e3a.js";import{h as S,e as T,F as R}from"./FileSaver.min.81b7fc4b.js";const z={name:"DialogEditCard",props:{type:String,doorOptions:Array},emits:["success"],setup(e,o){const l=i(null),r=u({visible:!1,oldForm:null,ruleForm:{cardNo:"",cardType:"",cardType:"",doorIds:[],username:"",realname:"",userInfo:""},rules:{cardNo:[{required:"true",message:"卡號不能為空",trigger:["change"]}],username:[{required:"true",message:"用戶名不能為空",trigger:["change"]}],realname:[{required:"true",message:"姓名不能為空",trigger:["change"]}],userInfo:[{required:"true",message:"住戶信息不能為空",trigger:["change"]}]}}),a=c();return s(d({formRef:l},p(r)),{open:e=>{const o=Object.assign({},e);o.doorIds=o.doorIds.map((({_id:e})=>e)),r.oldForm=o;const l=Object.assign({},o);r.ruleForm=l,r.visible=!0},readCard:()=>{const e=a.state.vbClientID;e?P.get(`/vue_api?m=card&_id=${e}`).then((e=>{const o=JSON.parse(e);if(console.log(o),o.message)return _.error(o.message),r.ruleForm.cardNo="",void(r.ruleForm.cardType="");const l=o.card.split(" ").join("");console.log({cardNo:l});const a=parseInt(l,16);a<1e8?(r.ruleForm.cardNo=a.toString(),r.ruleForm.cardType="idi"):(r.ruleForm.cardNo=l,r.ruleForm.cardType="idm"),_.success("成功讀取卡號")})).catch((e=>{P.isAxiosError(e)?j(e):console.error(e)})):_.warning("請先在端口管理頁面選擇 VB 客戶端")},submitForm:()=>{l.value.validate().then((l=>{if(l)if("add"==e.type)P.put("/card/add",r.ruleForm).then((()=>{o.emit("success"),r.visible=!1})).catch((e=>{P.isAxiosError(e)?j(e):console.error(e)}));else{if(N(r.oldForm,r.ruleForm))return void(r.visible=!1);console.log("提交服务器"),P.post("/card/update",r.ruleForm).then((()=>{o.emit("success"),r.visible=!1})).catch((e=>{P.isAxiosError(e)?j(e):console.error(e)}))}}))}})}},E=F("讀卡"),U={style:{display:"inline-block",width:"60px"}},A={style:{color:"#8492a6"}},Y={class:"dialog-footer"},q=F("取 消"),$=F("確 定");z.render=function(e,o,l,r,a,t){const n=m("el-input"),d=m("el-button"),s=m("el-form-item"),i=m("el-option"),u=m("el-select"),c=m("el-form"),p=m("el-dialog");return g(),f(p,{title:"add"==l.type?"添加門禁":"修改門禁",modelValue:e.visible,"onUpdate:modelValue":o[8]||(o[8]=o=>e.visible=o),width:"500px"},{footer:b((()=>[h("span",Y,[h(d,{onClick:o[7]||(o[7]=o=>e.visible=!1)},{default:b((()=>[q])),_:1}),h(d,{type:"primary",onClick:r.submitForm},{default:b((()=>[$])),_:1},8,["onClick"])])])),default:b((()=>[h(c,{model:e.ruleForm,rules:e.rules,ref:"formRef","label-width":"100px",class:"door-form"},{default:b((()=>[h(s,{label:"卡號",prop:"cardNo"},{default:b((()=>[h(n,{style:{width:"280px"},type:"text",modelValue:e.ruleForm.cardNo,"onUpdate:modelValue":o[1]||(o[1]=o=>e.ruleForm.cardNo=o),disabled:""},null,8,["modelValue"]),h(n,{style:{width:"280px"},type:"text",modelValue:e.ruleForm.cardType,"onUpdate:modelValue":o[2]||(o[2]=o=>e.ruleForm.cardType=o),disabled:""},null,8,["modelValue"]),h(d,{style:{"margin-left":"8px"},onClick:y(r.readCard,["prevent"])},{default:b((()=>[E])),_:1},8,["onClick"])])),_:1}),h(s,{label:"門禁"},{default:b((()=>[h(u,{modelValue:e.ruleForm.doorIds,"onUpdate:modelValue":o[3]||(o[3]=o=>e.ruleForm.doorIds=o),multiple:"",placeholder:"请选择門禁"},{default:b((()=>[(g(!0),f(w,null,v(l.doorOptions,(e=>(g(),f(i,{key:e._id,label:e.building+" "+e.unit,value:e._id},{default:b((()=>[h("span",U,C(e.building),1),h("span",A,C(e.unit),1)])),_:2},1032,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),h(s,{label:"用戶名",prop:"username"},{default:b((()=>[h(n,{type:"text",modelValue:e.ruleForm.username,"onUpdate:modelValue":o[4]||(o[4]=o=>e.ruleForm.username=o)},null,8,["modelValue"])])),_:1}),h(s,{label:"姓名",prop:"realname"},{default:b((()=>[h(n,{type:"text",modelValue:e.ruleForm.realname,"onUpdate:modelValue":o[5]||(o[5]=o=>e.ruleForm.realname=o)},null,8,["modelValue"])])),_:1}),h(s,{label:"住戶信息",prop:"userInfo"},{default:b((()=>[h(n,{type:"text",modelValue:e.ruleForm.userInfo,"onUpdate:modelValue":o[6]||(o[6]=o=>e.ruleForm.userInfo=o)},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["title","modelValue"])};const B={name:"Card",components:{DialogEditCard:z},setup(){const e=i(null),o=i(null),l=u({loading:!1,list:[],tableData:[],total:0,currentPage:1,pageSize:10,type:"add",doorOptions:[]});x((()=>{r(),a()}));const r=()=>{l.loading=!0,P.get("/card/list").then((e=>{const o=(l.currentPage-1)*l.pageSize,r=o+l.pageSize;l.list=e,l.total=e.length,l.tableData=e.slice(o,r),l.loading=!1})).catch((e=>{console.error(e)}))},a=()=>{P.get("/door/list").then((e=>{l.doorOptions=e.list})).catch((e=>{console.error(e)}))};return s(d({tableRef:e,editItemRef:o},p(l)),{handleAdd:()=>{l.type="add",o.value.open({cardNo:"",doorIds:[],username:"",realname:"",userInfo:""})},handleDownload:()=>{const e=S().format("YYYYMMDD_HHmmss"),o=l.list,r=`Card_${e}.xlsx`,a=new T.exports.Workbook,t=a.addWorksheet("Card");t.addRow(["卡號","類型","門禁","用戶名","姓名","住戶信息"]),t.getColumn(3).alignment={wrapText:!0},t.getColumn(1).width=24,t.getColumn(2).width=16,t.getColumn(3).width=18,t.getColumn(4).width=24,t.getColumn(5).width=24,t.getColumn(6).width=48,t.getRow(1).font={size:12,bold:!0};for(let l=0,n=o.length;l<n;l++){const{cardNo:e,cardType:r,doorIds:a,username:n,realname:d,userInfo:s}=o[l],i=a.map((({building:e,unit:o})=>`${e} ${o}`)).join("\r\n");t.addRow([e,r,i,n,d,s])}a.xlsx.writeBuffer().then((e=>{R.exports.saveAs(new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r)})).catch((e=>{console.error(e)}))},handleEdit:e=>{l.type="edit",o.value.open(e)},handleDelete:e=>{console.log({_id:e}),P.delete("/card/remove",{data:{_id:e}}).then((()=>{r()}))},changePage:e=>{l.currentPage=e,r()},refreshData:r})}},W=D();I("data-v-1400e21b");const H={class:"header"},M=F("添加"),J=F("導出"),Q={style:{display:"inline-block",width:"80px"}},X=h("a",{style:{cursor:"pointer"}},"删除",-1);V();const G=W(((e,o,l,r,a,t)=>{const n=m("el-button"),d=m("el-table-column"),s=m("el-popconfirm"),i=m("el-table"),u=m("el-pagination"),c=m("el-card"),p=m("DialogEditCard"),b=k("loading");return g(),f(w,null,[h(c,{class:"index-container"},{header:W((()=>[h("div",H,[h(n,{type:"primary",size:"small",icon:"el-icon-plus",onClick:r.handleAdd},{default:W((()=>[M])),_:1},8,["onClick"]),h(n,{size:"small",icon:"el-icon-download",onClick:r.handleDownload},{default:W((()=>[J])),_:1},8,["onClick"])])])),default:W((()=>[O(h(i,{ref:"tableRef",data:e.tableData,"tooltip-effect":"dark",style:{width:"100%"}},{default:W((()=>[h(d,{prop:"cardNo",label:"卡號",width:"200"}),h(d,{prop:"cardType",label:"類型",width:"200"}),h(d,{label:"門禁",width:"200"},{default:W((e=>[(g(!0),f(w,null,v(e.row.doorIds,(e=>(g(),f("div",{key:e._id},[h("span",Q,C(e.building),1),h("span",null,C(e.unit),1)])))),128))])),_:1}),h(d,{prop:"username",label:"用戶名"}),h(d,{prop:"realname",label:"姓名"}),h(d,{prop:"userInfo",label:"住戶信息"}),h(d,{label:"操作",width:"100"},{default:W((e=>[h("a",{style:{cursor:"pointer","margin-right":"10px"},onClick:o=>r.handleEdit(e.row)},"修改",8,["onClick"]),h(s,{title:"确定删除吗？",onConfirm:o=>r.handleDelete(e.row._id)},{reference:W((()=>[X])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"]),[[b,e.loading]]),h(u,{background:"",layout:"prev, pager, next",total:e.total,"page-size":e.pageSize,"current-page":e.currentPage,onCurrentChange:r.changePage},null,8,["total","page-size","current-page","onCurrentChange"])])),_:1}),h(p,{ref:"editItemRef",type:e.type,doorOptions:e.doorOptions,onSuccess:r.refreshData},null,8,["type","doorOptions","onSuccess"])],64)}));B.render=G,B.__scopeId="data-v-1400e21b";export default B;
